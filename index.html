<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicator Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>Indicator Dashboard</h1>

    <!-- Biểu đồ hình quạt: Value theo Indicator_name của tháng gần nhất -->
    <div class="chart-container">
        <h2>Cơ cấu Indicator_name tháng gần nhất</h2>
        <canvas id="doughnutChart"></canvas>
    </div>

    <!-- Biểu đồ đường: Xu thế Indicator_name theo thời gian cho các Market -->
    <div class="chart-container">
        <h2>Xu thế Indicator_name theo thời gian</h2>
        <canvas id="lineChart"></canvas>
    </div>

    <!-- Biểu đồ hình cột: Indicator_name theo tháng của từng Market -->
    <div class="chart-container">
        <h2>Indicator_name theo thị trường và tháng</h2>
        <canvas id="barChart"></canvas>
    </div>

    <script>
        // Load CSV file via PapaParse
        Papa.parse("data.csv", {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                processData(results.data);
            }
        });

        function processData(data) {
            const markets = {};
            const indicatorNameValues = {};
            const dateLabels = new Set();

            // Xử lý dữ liệu từ CSV
            data.forEach(row => {
                const market = row['Market'];
                const date = new Date(row['Date']);
                const indicatorName = row['Indicator_name'];
                const value = row['Value']; // Giá trị

                if (!markets[market]) {
                    markets[market] = {};
                }
                if (!indicatorNameValues[market]) {
                    indicatorNameValues[market] = {};
                }

                const yearMonth = `${date.getFullYear()}-${('0' + (date.getMonth() + 1)).slice(-2)}`;
                dateLabels.add(yearMonth);

                if (!markets[market][yearMonth]) {
                    markets[market][yearMonth] = 0;
                }
                if (!indicatorNameValues[market][yearMonth]) {
                    indicatorNameValues[market][yearMonth] = 0;
                }

                markets[market][yearMonth] += value;
                indicatorNameValues[market][yearMonth] += value;
            });

            const sortedDateLabels = Array.from(dateLabels).sort();

            // Dữ liệu biểu đồ hình quạt (indicator_name của tháng gần nhất)
            const latestMonth = sortedDateLabels[sortedDateLabels.length - 1];
            const doughnutLabels = [];
            const doughnutValues = [];
            Object.keys(markets).forEach(market => {
                if (indicatorNameValues[market][latestMonth]) {
                    doughnutLabels.push(market);
                    doughnutValues.push(indicatorNameValues[market][latestMonth]);
                }
            });

            // Dữ liệu biểu đồ đường và biểu đồ cột
            const lineDatasets = [];
            const barDatasets = [];
            Object.keys(markets).forEach(market => {
                const marketData = sortedDateLabels.map(date => indicatorNameValues[market][date] || 0);

                lineDatasets.push({
                    label: market,
                    data: marketData,
                    borderColor: getRandomColor(),
                    fill: false
                });

                barDatasets.push({
                    label: market,
                    data: marketData,
                    backgroundColor: getRandomColor()
                });
            });

            // Tạo biểu đồ hình quạt
            createDoughnutChart(doughnutLabels, doughnutValues);

            // Tạo biểu đồ đường
            createLineChart(sortedDateLabels, lineDatasets);

            // Tạo biểu đồ cột
            createBarChart(sortedDateLabels, barDatasets);
        }

        function createDoughnutChart(labels, data) {
            const ctx = document.getElementById('doughnutChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(() => getRandomColor())
                    }]
                }
            });
        }

        function createLineChart(labels, datasets) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(labels, datasets) {
            const ctx = document.getElementById('barChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>
</body>
</html>
